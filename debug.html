<html>

<head>
	<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>

<body>
	<p><button id="btn-connect" disabled>Connect</button>
		<span id="connection-status"></span>
	</p>
	<p>
		<input type="text" id="data-account" /><span id="lamports"></span>
		<button id="generate-account" disabled>Generate account key and create</button>
		<button id="add-more" disabled>Add SOLs</button>
		<button id="btn-withdraw" disabled>Remove SOLs</button>
	</p>
	<button id="btn-send" disabled>Send</button>
	<script type="text/javascript">
		window.addEventListener('load', function () {
			const btn_connect = window.document.getElementById("btn-connect");
			const btn_generate_account = window.document.getElementById("generate-account");
			const data_account = document.getElementById("data-account");
			const add_more_button = document.getElementById("add-more");
			btn_connect.disabled = false;
			btn_connect.addEventListener('click', () => {
				const connection_status = window.document.getElementById("connection-status");
				connection_status.innerHTML = "Connecting";
				window.solana.on("connect", () => {
					const connection = new solanaWeb3.Connection("http://127.0.0.1:8899");
					connection_status.innerHTML = `Connected as ${solana.publicKey.toString()}`;
					const btn_send = document.getElementById("btn-send");
					const btn_withdraw = document.getElementById("btn-withdraw");
					btn_send.disabled = false;
					btn_withdraw.disabled = false;
					btn_generate_account.disabled = false;
					add_more_button.disabled = false;

					btn_send.addEventListener('click', async () => {
						const instruction = new solanaWeb3.TransactionInstruction({
							// keys: [{ pubkey: new solanaWeb3.PublicKey("9FRakBFwajAdRhfqwLFWAWUuEySs7rcRviMA5xnrHqST"), isSigner: false, isWritable: true }], // All instructions are hellos
							keys: [
								{ pubkey: new solanaWeb3.PublicKey(data_account.value), isSigner: false, isWritable: true },
								{ pubkey: solana.publicKey, isSigner: true, isWritable: false },
							], // All instructions are hellos
							programId: new solanaWeb3.PublicKey("3cbqMCdkwiTbWyCv3i7gss8STqGw6ggzvg8ztt5msnD4"),
							data: new Uint8Array([0])// window.solana.publicKey.toBytes(),
						});
						const bh = (
							await connection.getRecentBlockhash()).blockhash;
						console.log(bh);
						const transaction = new solanaWeb3.Transaction({
							feePayer: window.solana.publicKey,
							recentBlockhash: bh,
						});
						transaction.add(instruction);
						const signedTransaction = await window.solana.signTransaction(transaction);
						await connection.sendRawTransaction(signedTransaction.serialize());
						alert('done');
					});
					
					btn_withdraw.addEventListener('click', async () => {
						const instruction = new solanaWeb3.TransactionInstruction({
							// keys: [{ pubkey: new solanaWeb3.PublicKey("9FRakBFwajAdRhfqwLFWAWUuEySs7rcRviMA5xnrHqST"), isSigner: false, isWritable: true }], // All instructions are hellos
							keys: [
								{ pubkey: new solanaWeb3.PublicKey(data_account.value), isSigner: false, isWritable: true },
								{ pubkey: solana.publicKey, isSigner: true, isWritable: false },
							], // All instructions are hellos
							programId: new solanaWeb3.PublicKey("3cbqMCdkwiTbWyCv3i7gss8STqGw6ggzvg8ztt5msnD4"),
							data: new Uint8Array([1])// window.solana.publicKey.toBytes(),
						});
						const bh = (
							await connection.getRecentBlockhash()).blockhash;
						console.log(bh);
						const transaction = new solanaWeb3.Transaction({
							feePayer: window.solana.publicKey,
							recentBlockhash: bh,
						});
						transaction.add(instruction);
						const signedTransaction = await window.solana.signTransaction(transaction);
						await connection.sendRawTransaction(signedTransaction.serialize());
						alert('done');
					});

					data_account.value = window.localStorage.getItem("account-id");
					if (data_account.value) {
						connection.getAccountInfo(new solanaWeb3.PublicKey(data_account.value)).then((acc) => {
							console.log(acc);
							const lamports = document.getElementById("lamports");
							lamports.innerHTML = `${Math.ceil(acc.lamports / solanaWeb3.LAMPORTS_PER_SOL)} SOL`;
							//alert(acc.owner);
						});
					}
					btn_generate_account.addEventListener("click", async () => {
						const keypair = solanaWeb3.Keypair.generate();
						data_account.value = keypair.publicKey;
						window.localStorage.setItem("account-id", keypair.publicKey);
						const instruction = solanaWeb3.SystemProgram.createAccount({
							keys: [
								{ pubkey: solana.publicKey, isSigner: true, isWritable: true },
								{ pubkey: keypair.publicKey, isSigner: true, isWritable: true },
							], // All instructions are hellos
							fromPubkey: solana.publicKey,
							newAccountPubkey: keypair.publicKey,
							lamports: 10000000,
							space: 10000,
							programId: new solanaWeb3.PublicKey("3cbqMCdkwiTbWyCv3i7gss8STqGw6ggzvg8ztt5msnD4"),
						});
						const bh = (await connection.getRecentBlockhash()).blockhash;
						console.log('bh=', bh);
						const transaction = new solanaWeb3.Transaction({
							feePayer: window.solana.publicKey,
							recentBlockhash: bh,
						});
						transaction.add(instruction);
						transaction.partialSign(keypair);
						const signedTransaction = await window.solana.signTransaction(transaction);
						await connection.sendRawTransaction(signedTransaction.serialize());
						alert('Created');
						const acc = await connection.getAccountInfo(keypair.publicKey);
						console.debug(acc);
						return;
						{
							// WHY
							const bh = (await connection.getRecentBlockhash()).blockhash;
							console.log('bh=', bh);
							const transaction = new solanaWeb3.Transaction({
								feePayer: window.solana.publicKey,
								recentBlockhash: bh,
							});
							transaction.add(solanaWeb3.SystemProgram.assign({
								accountPubkey: keypair.publicKey,
								programId: new solanaWeb3.PublicKey("3cbqMCdkwiTbWyCv3i7gss8STqGw6ggzvg8ztt5msnD4"),
							}));
							transaction.partialSign(keypair);
							const signedTransaction = await window.solana.signTransaction(transaction);
							await connection.sendRawTransaction(signedTransaction.serialize());
							alert('done');
						}
					});

					add_more_button.addEventListener('click', async () => {
						const instruction = solanaWeb3.SystemProgram.transfer({
							// keys: [{ pubkey: new solanaWeb3.PublicKey("9FRakBFwajAdRhfqwLFWAWUuEySs7rcRviMA5xnrHqST"), isSigner: false, isWritable: true }], // All instructions are hellos
							keys: [{ pubkey: window.solana.publicKey, isSigner: false, isWritable: true }], // All instructions are hellos
							//
							fromPubkey: window.solana.publicKey,
							toPubkey: new solanaWeb3.PublicKey(data_account.value),
							lamports: solanaWeb3.LAMPORTS_PER_SOL,
							// data: Buffer.alloc(0),
						});
						const bh = (await connection.getRecentBlockhash()).blockhash;
						const transaction = new solanaWeb3.Transaction({
							feePayer: window.solana.publicKey,
							recentBlockhash: bh,
						});
						transaction.add(instruction);
						const signedTransaction = await window.solana.signTransaction(transaction);
						await connection.sendRawTransaction(signedTransaction.serialize());
						alert('done');
						window.location.href = '';
					});
				});
				window.solana.connect();
			});
		});
	</script>
</body>

</html>